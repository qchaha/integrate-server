<!DOCTYPE html>
<!--
This is a starter template page. Use this page to start your new project from
scratch. This page gets rid of all links and provides the needed markup only.
-->
<html>

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>devops rookie</title>
  <!-- Tell the browser to be responsive to screen width -->
  <meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport">
  <link rel="stylesheet" href="bower_components/bootstrap/dist/css/bootstrap.min.css">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="bower_components/font-awesome/css/font-awesome.min.css">
  <!-- Ionicons -->
  <link rel="stylesheet" href="bower_components/Ionicons/css/ionicons.min.css">
  <!-- Theme style -->
  <link rel="stylesheet" href="dist/css/AdminLTE.min.css">
  <!-- DataTables -->
  <link rel="stylesheet" href="bower_components/datatables.net-bs/css/dataTables.bootstrap.min.css">
  <!-- vuetable2 -->
  <link rel="stylesheet" href="dist/css/vuetable-2.css">



  <!-- AdminLTE Skins. We have chosen the skin-blue for this starter
  page. However, you can choose any other skin. Make sure you
  apply the skin class to the body tag so the changes take effect. -->
  <link rel="stylesheet" href="dist/css/skins/skin-purple.min.css">

  <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]>
  <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
  <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
  <![endif]-->

  <!-- Google Font -->
  <link rel="stylesheet" href="dist/css/google-font.css">

  <!-- for flots label-->
  <style>
    .legendLabel {
      padding-right: 20px;
    }

    .fade-enter-active, .fade-leave-active{
      transition: all 0.5s ease
    }

    .table-height {
      height: 480px;
    }
    /*hover table color*/
    .table-hover tbody tr:hover td, .table-hover tbody tr:hover th {
      background-color: #f0f7ff;
      cursor: pointer;
    }
    .table-selected{
      background-color: #f0f7ff;
    }

    .datatable-icon{
      font-size: 18px;
    }
  </style>

  <style>
    [v-cloak] {
      display: none;
    }
  </style>

  <!--axios v0.17.1-->
  <script src="dist/js/axios.js"></script>

  <script>
    jwt = localStorage.getItem('jwt')
    var self = this;
    if (jwt) 
    {
      axios.post('/api/isauth_v1.0', {
        visit_token: jwt
      })
        .then(function (response) {
          if (response.data.rt_msg == "auth ok!") {
            console.log("auth ok!")
          }
          else {
            location.href = 'login.html'
          }
        })
        .catch(function (error) {
          console.log(error)
        })
    }
    else 
    {
      location.href = 'login.html'
    }
  </script>

</head>

<!--
BODY TAG OPTIONS:
=================
Apply one or more of the following classes to get the
desired effect
|---------------------------------------------------------|
| SKINS         | skin-blue                               |
|               | skin-black                              |
|               | skin-purple                             |
|               | skin-yellow                             |
|               | skin-red                                |
|               | skin-green                              |
|---------------------------------------------------------|
|LAYOUT OPTIONS | fixed                                   |
|               | layout-boxed                            |
|               | layout-top-nav                          |
|               | sidebar-collapse                        |
|               | sidebar-mini                            |
|---------------------------------------------------------|
-->

<body class="hold-transition skin-purple sidebar-mini">

  <div class="wrapper">
    <!----------------------
    Main Header
    ------------------------>
    <script src="dist/module-js/main-header.js"></script>

    <!------------------------------------------
    Left side column. contains the logo and sidebar
    -------------------------------------------->
    <script src="dist/module-js/main-sidebar.js"></script>

    <!------------------------------------------
    Content Wrapper. Contains page content
    -------------------------------------------->

    <div class="content-wrapper fade-enter-active fade-leave-active" id="vueapp" v-bind:style="{opacity: loading_status}" style="height:900px" v-cloak>
      <!-- Content Header (Page header) -->
      <section class="content-header">
        <h1>主机
          <small>Hosts</small>
        </h1>
      </section>
      <!--/. content-header-->
      <section class="content container-fluid">
        <!--hosts list-->
        <div class="col-md-12">
          <div class="box box-info" style="height:830px">
            <div class="box-header with-border">
              <h3 class="box-title">主机列表</h3>
            </div>
            <div class="mailbox-controls">
              <div class="btn-group" style="margin: -20px 20px -90px 5px">
                <button type="button" class="btn btn-default bg-purple" data-toggle="modal" data-target="#modal-addhost"><i class="fa fa-plus"></i> 添加</button>
              </div>
              <div class="btn-group" style="margin: -20px 20px -90px 10px">
                <button type="button" class="btn btn-default bg-red" data-toggle="modal" data-target="#modal-deletehost" v-if="delok"><i class="fa fa-minus"></i> 删除</button>
                <button type="button" class="btn btn-default bg-red disabled" v-if="!delok"><i class="fa fa-minus"></i> 删除</button>
              </div>
              <div class="btn-group" style="margin: -20px 20px -90px 10px">
                <button type="button" class="btn btn-default bg-gary" v-on:click="open_multiselect()"><i class="fa fa-tasks"></i> {{ ismulti }}</button>
                <button type="button" class="btn btn-default dropdown-toggle bg-gary" data-toggle="dropdown" aria-expanded="false" v-if="checkbox_show">
                  <span class="caret"></span>
                  <span class="sr-only">Toggle Dropdown</span>
                </button>
                <ul class="dropdown-menu" role="menu">
                  <li><a href="#">全选</a></li>
                  <li class="divider"></li>
                  <li><a href="#">取消选择</a></li>
                </ul>
              </div>
            </div>
            <!-- /.box-header -->
            <div class="box-body">
              <div class="table-responsive mailbox-messages">
                <table class="table table-hover" id="vuetable">
                  <thead>
                      <tr>
                        <th style="width: 10%">序号</th>
                        <th style="width: 20%">IP地址</th>
                        <th style="width: 15%">主机名</th>
                        <th style="width: 10%">状态</th>
                        <th style="width: 10%">OS</th>
                        <th style="width: 30%">操作</th>
                      </tr>
                  </thead>
                  <tbody style="font-weight:normal">
                    <tr v-for="(host, index) in host_info" v-bind:class="selected_class[index + 1]" style="height:44px" v-on:click="row_selected(host.hostname, host.ip_address, index + 1)">
                      <td>
                        <input type="checkbox" v-bind:id="index + 1" v-model="selected_rows" v-bind:value="index + 1" v-if="checkbox_show"></input>
                        <label v-bind:for="index" v-if="!checkbox_show">{{ index + 1 + '.' }}</label>
                      </td>
                      <td><a href="#">{{ host.ip_address }}</a></td>
                      <td><a href="#">{{ host.hostname }}</a></td>
                      <td>
                        <span class="badge bg-green" style="width: 40px" v-if="online[index + 1]">在线</span>
                        <span class="badge bg-red" style="width: 40px" v-if="offline[index + 1]">离线</span>
                        <i class="fa fa-spinner fa-spin" v-if="loading[index + 1]"></i>
                      </td>
                      <td><i class="fa fa-windows datatable-icon" v-if="host.os_type == 'Windows'"></i><i class="fa fa-linux datatable-icon" v-if="host.os_type == 'Linux'"></i></td>
                      <td>
                        <i style="padding: 0 15px 0 5px" class="fa fa-terminal datatable-icon" v-on:click="open_wetty(host.ip_address)" v-if="host.is_ssh"></i>
                        <i style="padding: 0 15px 0 5px" class="fa fa-television datatable-icon" v-on:click="remote_desktop(host.ip_address,'rdp')" v-if="host.is_rdp"></i>
                        <i style="padding: 0 15px 0 5px" class="fa fa-vimeo datatable-icon" v-on:click="remote_desktop(host.ip_address,'vnc')" v-if="host.is_vnc" ></i>
                        <i style="padding: 0 15px 0 5px" class="fa fa-folder-open datatable-icon" v-if="host.is_ftp"></i>
                        <i style="padding: 0 15px 0 5px" class="fa fa-folder-open-o datatable-icon" v-if="host.is_scp"></i>
                        <i style="padding: 0 15px 0 5px" class="fa fa-internet-explorer datatable-icon" v-if="host.is_http"></i>
                      </td>
                   </tr>
                  </tbody>
                </table>
                <!-- /.table -->
              </div>
              <!-- /.mail-box-messages -->
            </div>
            <!-- /.box-body -->
          </div>
        </div>
        <!--./hosts list-->
       </section>
      <!--./content container-fluid-->
  </div>
  <!--./wrapper-->


  <!--删除主机弹出的确认对话框-->
  <div class="modal fade" id="modal-deletehost">
    <div class="modal-dialog" style="width: 400px">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span></button>
            <h4 class="modal-title"><i class=" headline fa fa-warning text-red" style="padding: 0 10px 0 0 "></i>注意</h4>
          </div>
          <div class="modal-body">
            <p style="font-size:120%">被选中的主机将从"主机列表"中删除！</p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default pull-left" data-dismiss="modal">取消</button>
            <button type="button" class="btn btn-danger" onclick="v_vue.delete_host()" data-dismiss="modal">确定</button>
          </div>
        </div>
        <!-- /.modal-content -->
      </div>
      <!-- /.modal-dialog -->
    </div>
    <!-- /.modal -->

    <!-- 添加主机弹出的对话框 -->
    <div class="modal fade" id="modal-addhost">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span></button>
              <h4 class="modal-title"><i class=" headline fa fa-plus text-black" style="padding: 0 10px 0 0 "></i>添加主机</h4>
            </div>
            <div class="modal-body">
                <div class="box-header with-border">
                  <h3 class="box-title">填写主机信息</h3>
                </div>
                <!-- /.box-header -->
                <!-- form start -->
                <form class="form-horizontal">
                  <div class="box-body">
                    <div class="form-group">
                      <label class="col-sm-5 control-label">主机IP地址：</label>
                      <div class="input-group col-sm-4">
                        <div class="input-group-addon"><i class="fa fa-laptop" style="width: 12px"></i></div>
                        <input v-model="add_host_ip" class="form-control">
                      </div>
                      <!-- /.input group -->
                    </div>
                    <div class="form-group">
                      <label class="col-sm-5 control-label">系统管理员用户：</label>
                      <div class="input-group col-sm-4">
                        <div class="input-group-addon"><i class="fa fa-user" style="width: 12px"></i></div>
                        <input type="text" class="form-control" v-model="add_host_admin_user">
                      </div>
                    </div>
                    <div class="form-group">
                      <label class="col-sm-5 control-label">系统管理员密码：</label>
                      <div class="input-group col-sm-4">
                        <div class="input-group-addon"><i class="fa fa-lock" style="width: 12px"></i></div>
                        <input type="password" class="form-control" v-model="add_host_admin_password">
                      </div>
                    </div>
                    <div class="form-group">
                      <label class="col-sm-5 control-label">操作系统：</label>
                      <div class="input-group col-sm-4">
                        <div class="input-group-addon"><i class="fa fa-windows" style="width: 12px"></i></div>
                        <select class="form-control" v-model="add_host_os">
                          <option></option>
                          <option value="Redhat 6.5">Redhat 6.5</option>
                          <option value="Redhat 5.8">Redhat 5.8</option>
                          <option value="Win2008 R2 x64">Win2008 R2 x64</option>
                          <option value="Win2008 R2 x86">Win2008 R2 x86</option>
                          <option value="Win2003 x64">Win2003 x64</option>
                          <option value="Win2003 x86">Win2003 x86</option>
                        </select>
                      </div>
                    </div>
                  </div>
                  <!-- /.box-body -->
                </form>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-default pull-left" data-dismiss="modal">取消</button>
              <button type="button" class="btn btn-primary disabled" v-if="!(add_host_ip.length > 0 && add_host_admin_user.length > 0 && add_host_admin_password.length > 0 && add_host_os.length > 0)">确定</button>
              <button type="button" class="btn btn-primary" v-on:click="add_host()" data-dismiss="modal" v-if="(add_host_ip.length > 0 && add_host_admin_user.length > 0 && add_host_admin_password.length > 0 && add_host_os.length > 0)">确定</button>
            </div>
        </div>
      </div>
    </div>


  <!----------------------
          Main Footer
          ------------------------>
  <script src="dist/js/vue.js"></script>
  <script src="dist/module-js/main-footer.js"></script>
  </div>
  <!--./wrapper-->

  <!-- Page script -->

  <!-- jQuery 3 -->
  <script src="bower_components/jquery/dist/jquery.min.js"></script>
  <!-- Bootstrap 3.3.7 -->
  <script src="bower_components/bootstrap/dist/js/bootstrap.min.js"></script>
  <!-- DataTables -->
  <script src="bower_components/datatables.net/js/jquery.dataTables.min.js"></script>
  <!-- DataTables -->
  <script src="bower_components/datatables.net-bs/js/dataTables.bootstrap.min.js"></script>
  <!-- AdminLTE App slide navigator-->
  <script src="dist/js/adminlte.min.js"></script>


  <script>
    /****************************************************************************

    *****************************************************************************/

    var global_settimeout_id = 0;
    var global_loading_ticks = 0;

    //添加主机对话框vue
    var v_vue_modal_addhost = new Vue({
      el: '#modal-addhost',
      data: {
        add_host_ip: '',             //添加主机的ip地址
        add_host_admin_user: '',     //添加主机的管理员用户
        add_host_admin_password: '', //添加主机的管理员密码
        add_host_os: '',             //添加主机的操作系统
      },
      methods: {
          add_host: function(){
            var self = this;
            axios.post('/api/add_hosts_v1.0', {
              add_host_ip: self.add_host_ip,
              add_host_admin_user: self.add_host_admin_user,
              add_host_admin_password: self.add_host_admin_password,
              add_host_os: self.add_host_os
            })
            .then(function(response){
                if(response.data.op_result == "add sucessful!")
                {
                  window.location.reload();
                }
            })
            .catch(function(error){
              console.log(error);
            });
        }
      }
    });

    //页面vue
    var v_vue = new Vue({
      el: '#vueapp',
      data: {
        host_info: '',               //被选中显示实时状态的主机信息
        selected_hostname: '',       //显示到右方表头的主机名
        selected_ip: '',             //显示到右方表头的主机IP
        host_alive_info: [],         //保存列表中的主机是否在线的数组
        online: [],                  //与host_alive_info对应，控制表格样式，true显示“在线”
        offline: [],                 //与host_alive_info对应，控制表格样式，true显示“离线”
        loading: [],                 //与host_alive_info对应，控制表格样式，true显示“loading动画”
        loading_status: 0,           //页面初始化时进行模糊处理，效果像过渡
        loading_page: '',            //''为显示在echarts上的loading页面
        show: '',                    //''为显示echarts
        code404: 'none',             //''为显示echarts上的404错误页面，默认'none'不显示
        selected_class: [],          //记录table被选中状态
        selected_rows: [],           //记录checkbox被选中的行，传到后台
        checkbox_show: false,        //不点多选按钮前，不显示多选按钮，点击作为切换
        single_select_content: 0,    //记录点击多选前的状态，当返回单选状态时，切换回之前单选的状态
        ismulti: '多选',             //多选和单选按钮的标题
        isinit:  false,               //是否第一次运行，控制jquery table只在第一次运行时创建，其他刷新状态不再创建
        delok: false,                //控制开关，控制是否能点击删除
        add_host_ip: '',
      },
      mounted: function() {
        var self = this;
        self.find_all_host();   
        setTimeout(function(){self.loading_status = 1 },400)
      },
      methods: {
        remote_desktop: function(ip, protocol){
          axios.post("/api/remote_desktop_v1.0",{
            ip : ip,
            protocol : protocol,
          })
          .then(function(response){
            window.open("http://192.168.197.152:5001/guacd_client.html")
          })
          .catch(function(error){
            console.log(error)
          })
        },
        open_wetty: function(ip){
          axios.post('/api/open_wetty_v1.0',{
            ip : ip,
          })
          .then(function(response){
            //console.log(response.data.can_open_wetty)
            if( response.data.can_open_wetty == "edit wetty config file success!" )
            {
              window.open("http://192.168.197.152:5002")
            }
            else
            {
              console.log(response.data.can_open_wetty)
            }
          })
          .catch(function(error){
            console.log(error);
          });
        },
        find_all_host: function(){
          var self = this;
          //从mysql中获取所有主机信息
          axios.get('/api/find_all_host_v1.0')
            .then(function(response) {
              //重置状态
              self.delok = false;
              self.checkbox_show = false;
              self.single_select_content = 0;
              self.selected_class = [];
              Vue.set(self.selected_class, 1, 'table-selected');
              self.selected_rows = [];
              self.selected_rows[0] = 1;
              self.host_info = [];
              for( var i = 0; i < response.data.host_info.length; i++ )
              {
                Vue.set(self.host_info, i, response.data.host_info[i]);
              }
              self.selected_hostname = self.host_info[0].hostname;
              self.selected_ip = self.host_info[0].ip_address;

              for (var i = 1; i <= self.host_info.length; i++) {
                self.loading[i] = true;
              }
              self.check_host_alive();
              $(function() {
                $('#vuetable').DataTable({
                  "dom": "ftrip",
                  "destroy": false,
                  "pageLength": 13,
                  "columns": [
                    null,
                    null,
                    null,
                    null,
                    { "orderable": false },
                    { "orderable": false },
                  ]
                })
              });
              //self.isinit = false;
            })
            .catch(function(error) {
              console.log(error)
            });
        },
        show_echarts: function(hostname, ip) {
          var self = this;
          self.selected_hostname = hostname;
          self.selected_ip = ip;
          global_loading_ticks = 0;
          realtime = 'on';
          self.loading_complete();
        },
        check_host_alive: function() {
          //得到所有主机信息后，检查所有主机的是否在线的状态
          var self = this;
          for (var i = 1; i <= self.host_alive_info.length; i++) {
            Vue.set(self.online, i, false);
            Vue.set(self.offline, i, false);
            Vue.set(self.loading, i, true);
          }
          axios.get('/api/check_host_alive_v1.0')
            .then(function(response) {
              self.host_alive_info = response.data.host_alive_info;
              for (var i = 0; i < self.host_alive_info.length; i++) {
                if (self.host_alive_info[i] == "online") {
                  Vue.set(self.online, i + 1, true);
                  Vue.set(self.offline, i + 1, false);
                  Vue.set(self.loading, i + 1, false);
                } else {
                  Vue.set(self.online, i + 1, false);
                  Vue.set(self.offline, i + 1, true);
                  Vue.set(self.loading, i + 1, false);
                }
              }
              //当查询状态是否在线后，需要删除原先的表格，重新进行创建
              $(function() {
                $('#vuetable').DataTable({
                  "dom": "ftrip",
                  "destroy": true,
                  "pageLength": 13,
                  "columns": [
                    null,
                    null,
                    null,
                    null,
                    { "orderable": false },
                    { "orderable": false },
                  ]
                });
              });
              self.delok = true;
            })
            .catch(function(error) {
              console.log(error)
            });
        },
        loading_complete: function() {
          var self = this;
          if (global_loading_ticks > 1) {
            self.loading_status = 1;
            self.loading_page = 'none';
          } else {
            self.loading_status = 0.2;
            self.loading_page = '';
          }
        },
        //用于显示被选中的样式，用数组来记录每行表格每个值的数据
        row_selected: function(hostname, ip, id){
          var self = this;
          if( self.checkbox_show == false )
          {
            for(var i = 1; i < self.host_info.length + 1; i++)
            {
              if( i == id )
              {
                Vue.set(self.selected_class, i, 'table-selected');
                self.selected_rows = [];
                self.selected_rows.push(i);
              }
              else
              {
                Vue.set(self.selected_class, i, '');
              }
            }
          }
          else if( self.checkbox_show == true )
          {
            for( var i = 1; i < self.host_info.length + 1; i++ )
            {
              if( i == id )
              {
                if( self.selected_class[i] == 'table-selected' )
                {
                  Vue.set( self.selected_class, i ,'' );
                  for(var j = 0; j < self.selected_rows.length; j++)
                  {
                    if( self.selected_rows[j] == id )
                    {
                      self.selected_rows.splice(j , 1);
                    }
                  }
                }
                else
                {
                  Vue.set( self.selected_class, i ,'table-selected' );
                  self.selected_rows.push(i);
                }
              }
            }
          }
        },
        open_multiselect: function(){
          var self = this;
          //table是单选切换多选时，切换开关，然后记录单选时选中哪项，用于在多选返回单选时还原状态
          if( self.checkbox_show == false )
          {
            self.ismulti = '单选';
            self.checkbox_show = !self.checkbox_show;
            for( var i = 1; i < self.host_info.length + 1; i++ )
            {
              if( self.selected_class[i] == 'table-selected' )
              {
                single_select_content = i;
              }
            }
            self.selected_rows = [];
            self.selected_rows[0] = single_select_content;
            Vue.set(self.selected_class, single_select_content, 'table-selected');
          }
          //table是多选切换单选时，切换开关，然后切换至原单选上下文
          else
          {
            self.ismulti = '多选';
            self.checkbox_show = !self.checkbox_show;
            self.selected_class = [];
            Vue.set(self.selected_class, single_select_content, 'table-selected');
            self.selected_rows[0] = single_select_content;
          }
        },
        delete_host: function(){
          var self = this;
          var selected_ips = [];
          for( var i = 0; i < self.host_info.length + 1; i++ )
          {
            for( var j = 0; j < self.selected_rows.length; j++ )
            {
              if( self.selected_rows[j] == i )
                //console.log(self.host_info[self.selected_rows[j] - 1].ip)
                selected_ips.push(self.host_info[self.selected_rows[j] - 1].ip_address);
            }
          }
          axios.post('/api/delete_hosts_v1.0', {selected_ips: selected_ips})
          .then(function(response){
              if(response.data.op_result == "delete sucessful!")
              {
                window.location.reload();
              }
          })
          .catch(function(error){
            console.log(error);
          });
        }
      }
    });

  </script>
</body>

</html>
